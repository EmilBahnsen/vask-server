<head>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#ffffff">
    <script>
        // Language
        const isDanish = navigator.language.substr(0,2) === 'da';
        const sWash_ = isDanish ? 'Vask ' : 'Wash ';
        const sDry_ = isDanish ? 'Tørre ' : 'Dry ';
        document.title = isDanish ? 'Vaskestatus' : 'Wash Status'
        function formatStatus(text) {
            if (isDanish) {
                text = text.replace('Idle', 'Ledig');
                text = text.replace('Time left', 'Tid tilbage');
                text = text.replace('RH', '\nResterende fugt');
            } else {
                text = text.replace('RH', '\nRemaining humidity');
            }
            return text
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=.95">
    <meta http-equiv="refresh" content="60">
    <style>
        table {
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            text-align: left;
            /*border-bottom: 1px solid #ddd;*/
        }
        tr:hover {background-color:#f5f5f5;}
    </style>
    <script>
    function loadJSON(path, success, error) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    if (success)
                        success(JSON.parse(xhr.responseText));
                } else {
                    if (error)
                        error(xhr);
                }
            }
        };
        xhr.open("GET", path, true);
        xhr.send();
    }
    var states1, states2;
    let nDone = 0;

    function populateContent() {
        if (nDone !== 2) { return; }
        const body = document.getElementsByTagName('body')[0];

        function addRoom(states) {
            console.log(states);
            const tbl = document.createElement('table');
            tbl.style = 'display: inline-block; margin: 0 15px 15px 0';
            // tbl.style.width = '100%';
            tbl.setAttribute('border', '1');
            const tbdy = document.createElement('tbody');
            // Header
            const tr_header = document.createElement('tr');
            th_header = document.createElement('th');
            th_header.colSpan = 3;
            th_header.textContent = states['Location'];
            tr_header.appendChild(th_header);
            tbdy.appendChild(tr_header);
            // Body of table
            let nWash = 1, nDry = 1;
            for (var machine of states) {
                const tr = document.createElement('tr');
                const status_icon = document.createElement('td');
                const symbol = document.createElement('img');
                const symbol_size = 50;
                status_icon.appendChild(symbol);
                const name = document.createElement('td');
                if (machine['GroupNumber'] === 0) {
                    name.innerHTML = sWash_ + nWash;
                    nWash++;
                    symbol.src = 'wash.svg';
                } else if (machine['GroupNumber'] === 1) {
                    name.innerHTML = sDry_ + nDry;
                    nDry++;
                    symbol.src = 'dry.svg';
                }
                const state = document.createElement('td');
                state.innerHTML = formatStatus(machine['Text1']);
                if (machine['Text1'] === 'Idle') {
                    symbol.style = 'width: ' + symbol_size + 'px; background-color: green'
                } else {
                    symbol.style = 'width: ' + symbol_size + 'px; background-color: red;'
                }
                tr.appendChild(status_icon);
                tr.appendChild(name);
                tr.appendChild(state);
                tbdy.appendChild(tr);
            }
            tbl.appendChild(tbdy);
            body.append(tbl);
        }
        body.innerHTML = '';
        addRoom(states2);
        addRoom(states1);
    }

    loadJSON('status1.json', (data) => {states1 = data['MachineStates']; states1['Location'] = 'Finlandsgade 18'; nDone++; populateContent()}, (xhr) => console.log(xhr));
    loadJSON('status2.json', (data) => {states2 = data['MachineStates']; states2['Location'] = 'Helsingforsgade 11'; nDone++; populateContent()}, (xhr) => console.log(xhr));
    Notification.requestPermission(function(status) {
        console.log('Notification permission status:', status);
    });
    function displayNotification() {
      if (Notification.permission === 'granted') {
        navigator.serviceWorker.getRegistration().then(function(reg) {
          reg.showNotification('Hello world!');
        });
      }
    }
    </script>
</head>
<body>
Loading…
</body>
